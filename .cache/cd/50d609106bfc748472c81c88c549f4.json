{"id":"node_modules/@inrupt/solid-client-authn-browser/dist/ClientAuthentication.js","dependencies":[{"name":"G:\\VSC\\mysolidapp\\node_modules\\@inrupt\\solid-client-authn-browser\\dist\\ClientAuthentication.js.map","includedInParent":true,"mtime":1624384349172},{"name":"G:\\VSC\\mysolidapp\\node_modules\\@inrupt\\solid-client-authn-browser\\src\\ClientAuthentication.ts","includedInParent":true,"mtime":1624384349253},{"name":"G:\\VSC\\mysolidapp\\package.json","includedInParent":true,"mtime":1624384368825},{"name":"G:\\VSC\\mysolidapp\\node_modules\\@inrupt\\solid-client-authn-browser\\package.json","includedInParent":true,"mtime":1624384349238},{"name":"reflect-metadata","loc":{"line":15,"column":8},"parent":"G:\\VSC\\mysolidapp\\node_modules\\@inrupt\\solid-client-authn-browser\\dist\\ClientAuthentication.js","resolved":"G:\\VSC\\mysolidapp\\node_modules\\reflect-metadata\\Reflect.js"},{"name":"tsyringe","loc":{"line":16,"column":27},"parent":"G:\\VSC\\mysolidapp\\node_modules\\@inrupt\\solid-client-authn-browser\\dist\\ClientAuthentication.js","resolved":"G:\\VSC\\mysolidapp\\node_modules\\tsyringe\\dist\\esm5\\index.js"},{"name":"@inrupt/oidc-client-ext","loc":{"line":17,"column":34},"parent":"G:\\VSC\\mysolidapp\\node_modules\\@inrupt\\solid-client-authn-browser\\dist\\ClientAuthentication.js","resolved":"G:\\VSC\\mysolidapp\\node_modules\\@inrupt\\oidc-client-ext\\dist\\index.es.js"},{"name":"./constant","loc":{"line":18,"column":27},"parent":"G:\\VSC\\mysolidapp\\node_modules\\@inrupt\\solid-client-authn-browser\\dist\\ClientAuthentication.js","resolved":"G:\\VSC\\mysolidapp\\node_modules\\@inrupt\\solid-client-authn-browser\\dist\\constant.js"},{"name":"./login/oidc/IssuerConfigFetcher","loc":{"line":19,"column":38},"parent":"G:\\VSC\\mysolidapp\\node_modules\\@inrupt\\solid-client-authn-browser\\dist\\ClientAuthentication.js","resolved":"G:\\VSC\\mysolidapp\\node_modules\\@inrupt\\solid-client-authn-browser\\dist\\login\\oidc\\IssuerConfigFetcher.js"}],"generated":{"js":"\"use strict\";\r\nvar __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\r\n    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\r\n    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\r\n    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\r\n    return c > 3 && r && Object.defineProperty(target, key, r), r;\r\n};\r\nvar __metadata = (this && this.__metadata) || function (k, v) {\r\n    if (typeof Reflect === \"object\" && typeof Reflect.metadata === \"function\") return Reflect.metadata(k, v);\r\n};\r\nvar __param = (this && this.__param) || function (paramIndex, decorator) {\r\n    return function (target, key) { decorator(target, key, paramIndex); }\r\n};\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nrequire(\"reflect-metadata\");\r\nconst tsyringe_1 = require(\"tsyringe\");\r\nconst oidc_client_ext_1 = require(\"@inrupt/oidc-client-ext\");\r\nconst constant_1 = require(\"./constant\");\r\nconst IssuerConfigFetcher_1 = require(\"./login/oidc/IssuerConfigFetcher\");\r\nconst globalFetch = (request, init) => window.fetch(request, init);\r\nlet ClientAuthentication = class ClientAuthentication {\r\n    constructor(loginHandler, redirectHandler, logoutHandler, sessionInfoManager, issuerConfigFetcher) {\r\n        this.loginHandler = loginHandler;\r\n        this.redirectHandler = redirectHandler;\r\n        this.logoutHandler = logoutHandler;\r\n        this.sessionInfoManager = sessionInfoManager;\r\n        this.issuerConfigFetcher = issuerConfigFetcher;\r\n        this.login = async (options) => {\r\n            var _a, _b;\r\n            await this.sessionInfoManager.clear(options.sessionId);\r\n            const redirectUrl = oidc_client_ext_1.removeOidcQueryParam((_a = options.redirectUrl) !== null && _a !== void 0 ? _a : window.location.href);\r\n            await this.loginHandler.handle({\r\n                ...options,\r\n                redirectUrl,\r\n                clientName: (_b = options.clientName) !== null && _b !== void 0 ? _b : options.clientId,\r\n            });\r\n        };\r\n        this.fetch = globalFetch;\r\n        this.logout = async (sessionId) => {\r\n            await this.logoutHandler.handle(sessionId);\r\n            this.fetch = globalFetch;\r\n        };\r\n        this.getSessionInfo = async (sessionId) => {\r\n            return this.sessionInfoManager.get(sessionId);\r\n        };\r\n        this.getAllSessionInfo = async () => {\r\n            return this.sessionInfoManager.getAll();\r\n        };\r\n        this.validateCurrentSession = async () => {\r\n            const currentSessionId = window.localStorage.getItem(constant_1.KEY_CURRENT_SESSION);\r\n            if (currentSessionId === null) {\r\n                return null;\r\n            }\r\n            const sessionInfo = await this.sessionInfoManager.get(currentSessionId);\r\n            if (sessionInfo === undefined ||\r\n                sessionInfo.idToken === undefined ||\r\n                sessionInfo.clientAppId === undefined ||\r\n                sessionInfo.issuer === undefined) {\r\n                return null;\r\n            }\r\n            const issuerConfig = await this.issuerConfigFetcher.fetchConfig(sessionInfo.issuer);\r\n            try {\r\n                const jwks = await IssuerConfigFetcher_1.getJwks(issuerConfig);\r\n                if (await oidc_client_ext_1.validateIdToken(sessionInfo.idToken, jwks, sessionInfo.issuer, sessionInfo.clientAppId)) {\r\n                    return sessionInfo;\r\n                }\r\n            }\r\n            catch (e) {\r\n            }\r\n            return null;\r\n        };\r\n        this.handleIncomingRedirect = async (url) => {\r\n            const redirectInfo = await this.redirectHandler.handle(url);\r\n            this.fetch = redirectInfo.fetch;\r\n            const cleanedUpUrl = new URL(url);\r\n            cleanedUpUrl.searchParams.delete(\"state\");\r\n            cleanedUpUrl.searchParams.delete(\"code\");\r\n            cleanedUpUrl.searchParams.delete(\"id_token\");\r\n            cleanedUpUrl.searchParams.delete(\"access_token\");\r\n            window.history.replaceState(null, \"\", cleanedUpUrl.toString());\r\n            return {\r\n                isLoggedIn: redirectInfo.isLoggedIn,\r\n                webId: redirectInfo.webId,\r\n                sessionId: redirectInfo.sessionId,\r\n                expirationDate: redirectInfo.expirationDate,\r\n            };\r\n        };\r\n    }\r\n};\r\nClientAuthentication = __decorate([\r\n    tsyringe_1.injectable(),\r\n    __param(0, tsyringe_1.inject(\"browser:loginHandler\")),\r\n    __param(1, tsyringe_1.inject(\"browser:redirectHandler\")),\r\n    __param(2, tsyringe_1.inject(\"browser:logoutHandler\")),\r\n    __param(3, tsyringe_1.inject(\"browser:sessionInfoManager\")),\r\n    __param(4, tsyringe_1.inject(\"browser:issuerConfigFetcher\")),\r\n    __metadata(\"design:paramtypes\", [Object, Object, Object, Object, Object])\r\n], ClientAuthentication);\r\nexports.default = ClientAuthentication;\r\n"},"sourceMaps":{"js":{"version":3,"file":"ClientAuthentication.js","sourceRoot":"","sources":["../src/ClientAuthentication.ts"],"names":[],"mappings":"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","sourcesContent":["/*\r\n * Copyright 2021 Inrupt Inc.\r\n *\r\n * Permission is hereby granted, free of charge, to any person obtaining a copy\r\n * of this software and associated documentation files (the \"Software\"), to deal in\r\n * the Software without restriction, including without limitation the rights to use,\r\n * copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the\r\n * Software, and to permit persons to whom the Software is furnished to do so,\r\n * subject to the following conditions:\r\n *\r\n * The above copyright notice and this permission notice shall be included in\r\n * all copies or substantial portions of the Software.\r\n *\r\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,\r\n * INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A\r\n * PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT\r\n * HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION\r\n * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE\r\n * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\r\n */\r\n\r\n/**\r\n * @hidden\r\n * @packageDocumentation\r\n */\r\n\r\nimport \"reflect-metadata\";\r\nimport { injectable, inject } from \"tsyringe\";\r\nimport {\r\n  ILoginHandler,\r\n  ILogoutHandler,\r\n  IRedirectHandler,\r\n  ISessionInfo,\r\n  ISessionInfoManager,\r\n  IIssuerConfigFetcher,\r\n  ISessionInternalInfo,\r\n  ILoginOptions,\r\n} from \"@inrupt/solid-client-authn-core\";\r\nimport { removeOidcQueryParam, validateIdToken } from \"@inrupt/oidc-client-ext\";\r\nimport { KEY_CURRENT_SESSION } from \"./constant\";\r\nimport { getJwks } from \"./login/oidc/IssuerConfigFetcher\";\r\n\r\n// By only referring to `window` at runtime, apps that do server-side rendering\r\n// won't run into errors when rendering code that instantiates a\r\n// ClientAuthentication:\r\nconst globalFetch: typeof window.fetch = (request, init) =>\r\n  window.fetch(request, init);\r\n\r\n/**\r\n * @hidden\r\n */\r\n@injectable()\r\nexport default class ClientAuthentication {\r\n  constructor(\r\n    @inject(\"browser:loginHandler\") private loginHandler: ILoginHandler,\r\n    @inject(\"browser:redirectHandler\")\r\n    private redirectHandler: IRedirectHandler,\r\n    @inject(\"browser:logoutHandler\") private logoutHandler: ILogoutHandler,\r\n    @inject(\"browser:sessionInfoManager\")\r\n    private sessionInfoManager: ISessionInfoManager,\r\n    @inject(\"browser:issuerConfigFetcher\")\r\n    private issuerConfigFetcher: IIssuerConfigFetcher\r\n  ) {}\r\n\r\n  // Define these functions as properties so that they don't get accidentally re-bound.\r\n  // Isn't Javascript fun?\r\n  login = async (options: ILoginOptions): Promise<void> => {\r\n    // In order to get a clean start, make sure that the session is logged out\r\n    // on login.\r\n    // But we may want to preserve our client application info, particularly if\r\n    // we used Dynamic Client Registration to register (since we don't\r\n    // necessarily want the user to have to register this app each time they\r\n    // login).\r\n    await this.sessionInfoManager.clear(options.sessionId);\r\n\r\n    // In the case of the user hitting the 'back' button in their browser, they\r\n    // could return to a previous redirect URL that contains OIDC params that\r\n    // are now longer valid - so just to be safe, strip relevant params now.\r\n    const redirectUrl = removeOidcQueryParam(\r\n      options.redirectUrl ?? window.location.href\r\n    );\r\n\r\n    await this.loginHandler.handle({\r\n      ...options,\r\n      redirectUrl,\r\n      // If no clientName is provided, the clientId may be used instead.\r\n      clientName: options.clientName ?? options.clientId,\r\n    });\r\n  };\r\n\r\n  // By default, our fetch() resolves to the environment fetch() function.\r\n  fetch = globalFetch;\r\n\r\n  logout = async (sessionId: string): Promise<void> => {\r\n    await this.logoutHandler.handle(sessionId);\r\n\r\n    // Restore our fetch() function back to the environment fetch(), effectively\r\n    // leaving us with un-authenticated fetches from now on.\r\n    this.fetch = globalFetch;\r\n  };\r\n\r\n  getSessionInfo = async (\r\n    sessionId: string\r\n  ): Promise<(ISessionInfo & ISessionInternalInfo) | undefined> => {\r\n    // TODO complete\r\n    return this.sessionInfoManager.get(sessionId);\r\n  };\r\n\r\n  getAllSessionInfo = async (): Promise<ISessionInfo[]> => {\r\n    return this.sessionInfoManager.getAll();\r\n  };\r\n\r\n  validateCurrentSession = async (): Promise<\r\n    (ISessionInfo & ISessionInternalInfo) | null\r\n  > => {\r\n    const currentSessionId = window.localStorage.getItem(KEY_CURRENT_SESSION);\r\n    if (currentSessionId === null) {\r\n      return null;\r\n    }\r\n    const sessionInfo = await this.sessionInfoManager.get(currentSessionId);\r\n    // Several types of session data are required in order to validate that the ID\r\n    // token in storage hasn't been tampered with, and has actually been issued\r\n    // by the issuer present in storage.\r\n    if (\r\n      sessionInfo === undefined ||\r\n      sessionInfo.idToken === undefined ||\r\n      sessionInfo.clientAppId === undefined ||\r\n      sessionInfo.issuer === undefined\r\n    ) {\r\n      return null;\r\n    }\r\n    const issuerConfig = await this.issuerConfigFetcher.fetchConfig(\r\n      sessionInfo.issuer\r\n    );\r\n\r\n    try {\r\n      const jwks = await getJwks(issuerConfig);\r\n      if (\r\n        await validateIdToken(\r\n          sessionInfo.idToken,\r\n          jwks,\r\n          sessionInfo.issuer,\r\n          sessionInfo.clientAppId\r\n        )\r\n      ) {\r\n        return sessionInfo;\r\n      }\r\n    } catch (e) {\r\n      // If an error happens when fetching the keys, the issuer cannot be trusted.\r\n      // The error is swallowed, and `null` is eventually returned.\r\n    }\r\n    return null;\r\n  };\r\n\r\n  handleIncomingRedirect = async (\r\n    url: string\r\n  ): Promise<ISessionInfo | undefined> => {\r\n    const redirectInfo = await this.redirectHandler.handle(url);\r\n\r\n    this.fetch = redirectInfo.fetch;\r\n\r\n    const cleanedUpUrl = new URL(url);\r\n    cleanedUpUrl.searchParams.delete(\"state\");\r\n    // For auth code flow\r\n    cleanedUpUrl.searchParams.delete(\"code\");\r\n    // For implicit flow\r\n    cleanedUpUrl.searchParams.delete(\"id_token\");\r\n    cleanedUpUrl.searchParams.delete(\"access_token\");\r\n\r\n    // Remove OAuth-specific query params (since the login flow finishes with\r\n    // the browser being redirected back with OAuth2 query params (e.g. for\r\n    // 'code' and 'state'), and so if the user simply refreshes this page our\r\n    // authentication library will be called again with what are now invalid\r\n    // query parameters!).\r\n    window.history.replaceState(null, \"\", cleanedUpUrl.toString());\r\n\r\n    return {\r\n      isLoggedIn: redirectInfo.isLoggedIn,\r\n      webId: redirectInfo.webId,\r\n      sessionId: redirectInfo.sessionId,\r\n      expirationDate: redirectInfo.expirationDate,\r\n    };\r\n  };\r\n}\r\n"]}},"error":null,"hash":"6b93754dde16ad0ba07404930cbc2b47","cacheData":{"env":{}}}